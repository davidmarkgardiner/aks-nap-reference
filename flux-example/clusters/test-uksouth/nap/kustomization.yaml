# Test cluster - using 'patches' format (not deprecated patchesJson6902)
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../infrastructure/nap/base

# Use 'patches' with explicit target (recommended format)
patches:
  # NodePool disruption settings
  - target:
      group: karpenter.sh
      version: v1
      kind: NodePool
      name: default
    patch: |-
      - op: replace
        path: /spec/disruption/consolidationPolicy
        value: "WhenEmpty"
      - op: replace
        path: /spec/disruption/consolidateAfter
        value: "10m"
      - op: replace
        path: /spec/disruption/budgets
        value:
          - nodes: "10%"
          - nodes: "2"
          - nodes: "0"
            schedule: "0 8 * * mon-fri"
            duration: "10h"

  # AKSNodeClass tags
  - target:
      group: karpenter.azure.com
      version: v1beta1
      kind: AKSNodeClass
      name: default
    patch: |-
      - op: replace
        path: /spec/tags
        value:
          ManagedBy: karpenter
          Environment: test
          Cluster: test-uksouth
          Purpose: consolidation-testing

labels:
  - pairs:
      environment: test
      cluster: test-uksouth
